<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Lucio Pentagna">
    <link rel="icon" href="media/favicon.ico">
    <title>Fab Academy 2020 - Lucio Pentagna</title>
    <!-- Bootstrap core CSS -->
    <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="media/fabacademy.css" rel="stylesheet">
    <!-- 3D files viewer -->
    <script type="text/javascript" src="media/jsc3d_ie.min.js"></script>
    <script type="text/javascript" src="media/jsc3d.min.js"></script>
    <script type="text/javascript" src="media/jsc3d.webgl.js"></script>
    <script type="text/javascript" src="media/jsc3d.touch.js"></script>
    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="bootstrap/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="bootstrap/js/ie-emulation-modes-warning.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>    <![endif]-->
    <!-- Load the menu file -->
    <script>
        function menu() {
            $('#exercises').load("exercises-menu.html");
            $('#project').load("project-menu.html");
            $('#cclicense').load("license.html");
        }

    </script>
</head>

<body onload="menu()">
    <!-- Static navbar -->
    <nav class="navbar navbar-default navbar-static-top">
        <div class="container">
            <div class="navbar-header"> <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="index.html">Lucio Pentagna</a> </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="about.html">About</a></li>
                    <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Exercises <span class="caret"></span></a>
                        <ul id="exercises" class="dropdown-menu" role="menu"> </ul>
                    </li>
                    <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Final Project <span class="caret"></span></a>
                        <ul id="project" class="dropdown-menu" role="menu"> S</ul>
                    </li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </nav>
    <div class="container">
        <p>Diary Dates</p>
        <a href="#06/06/2020">06/06/2020</a>
        <a href="#07/06/2020">07/06/2020</a>
        <a href="#08/06/2020">08/06/2020</a>
        <a href="#09/06/2020">09/06/2020</a>
    </div>
    <div class="container">
        <!-- Insert your content here below! -->

        <h3>Final Project Diary and Concept Update</h3>
        <h4><a id="06/06/2020">6th of June, 2020</a></h4>
        <p>Today I decided to change my final project again!</p>
        <p>I needed to have irrigation working in the farm, I did not need more chicken right now, so well I changed again. It doesn't mean I gave up on the Chicken egg incubator. It only means I might have <b>TWO</b> final projects :-). Well maybe not, the reality is that I will focus on the irrigation, my fruit trees need the water, the greenhouse too. I have so much need for it right now and I need it to to work well that it makes it really worth the change.</p>
        <h4>So no Chickens! YES WATER!, maybe also Chickens.</h4>
        <hr>
        <h4>Design of my new proposition</h4>
        <p>As I am writing this there are no current design files, there is a sketch of a code and there is a prototype on a breadboard!</p>
        <p>There are in the other hand requirements for the hardware and for the software:</p>
        <h4>Software Requirements and stage</h4>
        <ol>
            <li>Simplify the code creating more functions;</li>
            <li>try to separate the HTML part for a cleaner code;</li>
            <li>Improve the appearance/Interface of the code;</li>
            <li>Add readings to HTML;</li>
            <li>Add a log of occurrences like over current;</li>
            <li>Add more safety for the equipment;</li>
            <li>Add a phone interface (APP);</li>
            <li>Add function to set current time;</li>
            <li>Add renaming function to each relay so one can relate the relay to the area of interest or at least rename relays to actual areas of the farm.</li>
        </ol>
        <h4>Design Requirements and situation</h4>
        <ol>
            <li>Need to be water resistant at least;</li>
        </ol>
        <hr>
        <h4><a id="07/06/2020">7th of June, 2020</a></h4>
        <p>As of today 07th of June 2020 the development is like this.</p>
        <p class="pic"> <img src="media/final_project/images/initial_stage/initial01.jpg">
            <legend>What I start with is a system that works on a Uno and is a torture on a ESP8266 besides is a shock hazard and because of water damage I need to replace some relays.</legend>
        </p>
        <p>The code running on this setup can be found on the Fabfarm Github <a href="https://github.com/fabfarm/autovalve/tree/master/Uno/Irrigation/original/irrigation_system_arduino_code">Autovalve</a></p>
        <p>Shakeel one of our volunteers managed to create a version that runs on a ESP8266 that can be found in the same repo <a href="https://github.com/fabfarm/autovalve/tree/master/ESP8266_NodeMCU/Irrigation_System_NodeMCU_RTC_ACS712v2">here</a>. Due to the Pandemic situation he left us in a hurry and did not have time to test his code so it worked but not stable due to the fact that he heroically attempted to share the analog pin with the wifi, leading to drops in the wifi that rendered using the system almost impossible. This is the code that I started with.</p>
        <hr>
        <h4><a id="08/06/2020">8th of June, 2020</a></h4>
        <p>After many hours trying to understand the code I managed to port Shakeel's code to a ESP32 and also split the file with each function on a separate file. </p>
        <p>In this video I show the progress I did so far in the merging the codes and having it work in the ESP32</p>
        <p class="pic"> <video controls>
                <source src="media/final_project/images/initial_stage/initial03_codediff.mp4"> Your browser does not support HTML5 video.
            </video>
            <legend>Check hight resolution version on <a href="https://youtu.be/oxlblIs7CC0">Youtube</a></legend>
        </p>
        <p>To port the code to ESP32 might be simple for a programmer but it took many hours for me.</p>
        <p>Steps:</p>
        <ol>
            <li>separated everything that was a function already to its own file to make it more readable;</li>
            <li>Opened then another session of the Arduino IDE and started copying every part of the code line by line to the new session, in this session I renamed the main file to "esp32irrigation"</li>
            <li>remapped the pins to ESP32 pins</li>
            <li>run beautify on the HTML on Brackets</li>
            <li>organized the code so pins are on top</li>
            <li>created variables for the RTC pins</li>
            <li>Commented parts of the code that print error to the serial monitor</li>
        </ol>
        <p>The code is to big for displaying on the HTML so I will leave a link for the state of the code as this early morning: <a href="https://github.com/fabfarm/autovalve/tree/master/ESP32/esp32irrigation_historical_no_change"> codehere</a>.</p>
        <p>Here in this video you can see the testing setup of the current irrigation system of the farm</p>
        <p class="pic"> <video controls>
                <source src="media/final_project/images/initial_stage/initial02_showthesetup.mp4"> Your browser does not support HTML5 video.
            </video>
            <legend>Check hight resolution version on <a href="https://youtu.be/ytQwHZToBWM">Youtube</a></legend>
        </p>
        <hr>
        <h4><a id="09/06/2020">9th of June, 2020</a></h4>
        <p>Today after testing the relays I realized that some relays work some not. After testing on the lab power supply directly with 5volts applied to the signal pin I believe that this is due to low voltage being supplied by the esp32 or the signal voltage.</p>
        <p>I watched then the Great Scott's video on Youtube about <a href="https://www.youtube.com/watch?v=2BdevOmN-Zk">relays and optocouplers</a>.</p>
        <p>I will make sure the relays have at least a 5 volts power supply. Wich are their required voltage acording to the <a href="media/final_project/datasheet/SRD-12VDC-xx-x_ETC.pdf">datasheet</a>. The signal should be fine at 3.3. Will be tested in situ.</p>
        <p class="pic"> <img src="media/final_project/images/initial_stage/initial04.jpg">
            <legend></legend>
        </p>
        <p>The other point is the current reading that is completely wrong. In other to have the irrigation system working I will have to run it without current sensing until debugged.</p>
        <hr>
        <h4><a id="10/06/2020">10th of June, 2020</a></h4>
        <p>After the tests, the conclusion to the voltage problem is that the esp32 should not supply power to the relay, that should be supplied from an external power source, set at 5volts. The signal can come from the esp32 unchanged but the esp 32 should share the same ground.</p>
        <p>more changes in the code:</p>
        <ol>
            <li>increased the interval the time is displayed from 3000 to 5000 ms (5s) in the variable <code>RTCtimeInterval</code></li>
            <li>increased the interval the setup is displayed from 10000 to 30000 ms (30s) in the variable <code>configTimeInterval</code> </li>
            <li>Set recognizable names to the relay's html interface</li>
            <li>Cleaned up a bit more on the serial monitor by removing seconds from the setting display</li>
        </ol>
        <p>I will place the setup back to work today in the morning and set times for each irrigation and field test the esp32 irrigation module.</p>
        <p>Strangely the external RTC clock is not keeping accurate time. I will look into utilizing internal clock with external battery in case of power failure.</p>
        <p>According to <a href="https://github.com/espressif/arduino-esp32/issues/3641">this closed issue discussion at the esp repo at Github</a> and this <a href="https://www.esp32.com/viewtopic.php?t=3715#p17038">esp accuracy topic</a> the internal clock will delay "Internal RTC clock frequency error is about 5%", this can be solved with a external crystal of 32.768KHz crystal assembled according to the schematics below:</p>
        <p>Another solution would be to have the esp always connected to the Internet and grabbing the time from the Internet updates to compensate for inaccuracy.</p>
        <p class="pic"> <img src="media/final_project/images/initial_stage/73125119-71fc6c80-3f60-11ea-879e-9a5b5f027982.jpg">
        </p>
        <p>After wakeup update</p>
        <p>Today I went into installing the temporary testing setup. I troubleshoot a few problems.</p>
        <ol>
            <li>Setup was not working when disconnected from computer: -solution power wiring was not correct, ended up connecting 2 USB cables one for the ESP32 and another for the relays, they both share the same ground, also I might have solved the RTC clock problem as well with the same approach.</li>
            <li></li>
        </ol>
        <p>This is how the prototype looks now:</p>
        <p class="pic"><img src="media/final_project/images/initial_stage/initial05.jpg"><legend>Still need to wire the pump and the solenoid valves.</legend></p>
        <p class="pic"><img src="media/final_project/images/initial_stage/initial06.jpg"><legend>I hope the wasps don't mind the invasion</legend></p>
        <p class="pic"><img src="media/final_project/images/initial_stage/initial07.jpg"><legend>Wiring the system</legend></p>
        <p class="pic"> <video controls>
                <source src="media/final_project/images/initial_stage/initial08360.mp4"> Your browser does not support HTML5 video.
            </video><legend>testing...testing...</legend>
        </p>
        <p>After the tests I went back to the code for more customization.</p>
        <p>I first watched a series of <a href="">videos on Youtube</a> about functions really create and then started creating even more functions.</p>
        <p>Basically I went into looking how to reduce code repetitions and how to send a value to a function</p>
        <p>From the code available I created this function:</p>
        <pre><code>void turnOffRelay(int valveHere){
  // wait then turn valve relay OFF
  
  
  Serial.print("Waiting ");
  Serial.print(waitTimeValveOff / 1000);
  Serial.println("s before deactivating Valve Relay 3.");
  delay(waitTimeValveOff);
  digitalWrite(valveHere, LOW);
  valveHere = 0;
  Serial.print("*** Valve Relay ");
  Serial.print(valveHere);
  Serial.println("3 turned OFF ***");
}</code></pre>
        <p>Every time I want to call this function I use
        </p>
        <pre><code>      {
        int valveHere = valveRelay3;
        turnOffRelay (valveHere);
      }</code></pre>
        <p>The reason I use the <code>{}</code> is because I had to declare the local variable <code>valveHere</code> this way I could replace only that piece of code each time I called the function.</p>
        <p>Technically calling that function would be just having this code here <code>turnOffRelay (valveHere);</code> but that would not work alone as I am always replacing the valve relay pin with <code>int valveHere = valveRelay3;</code></p>
        <p>I still haven't tested the behaviour but at least it compiles :-)</p>
        <hr>
        <h4>Footnote</h4>
        <p>Links:</p>
        <p><a href="https://randomnerdtutorials.com/esp32-esp8266-input-data-html-form/">Rui Silva's resources on ESP32</a></p>
        <p><a href="https://lastminuteengineers.com/esp32-arduino-ide-tutorial/">Last Minute Engineer</a></p>
        <p><a href="https://randomnerdtutorials.com/esp32-adc-analog-read-arduino-ide/">Random Nerd Tutorials</a></p>
        <!-- End of your content -->
    </div> <!-- /container -->
    <!-- footer -->
    <footer id="footer">
        <p id="cclicense"> </p>
        <p class="license"> Theme: <a href="https://github.com/openp2pdesign/FabAcademy_Template">Fab Academy Template</a> by <a href="http://openp2pdesign.org">Massimo Menichinelli</a> <br> Based on <a href="http://getbootstrap.com/">Twitter Bootstrap</a>+<a href="http://jquery.com/">JQuery</a>+<a href="https://code.google.com/p/google-code-prettify/">google-code-prettify</a>+<a href="http://jmblog.github.io/color-themes-for-google-code-prettify/github/">GitHub theme for google-code-prettify</a>+<a href="https://code.google.com/p/jsc3d/">JSC3D</a>+<a href="https://github.com/thegrubbsian/jquery.ganttView">jquery.ganttView</a>.
        </p>
    </footer>

    <!-- Do not touch this! -->
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="media/jquery-1.9.1.min.js"></script>
    <!-- Syntax Highlighter -->
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"> </script> <!-- From https://github.com/jmblog/color-themes-for-google-code-prettify -->
    <link href="media/github.css" type="text/css" rel="stylesheet">
    <script type="text/javascript">
        ! function($) {
            $(function() {
                window.prettyPrint && prettyPrint()
            })
        }(window.jQuery)

    </script>
    <script src="bootstrap/js/bootstrap.min.js"></script> <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="bootstrap/js/ie10-viewport-bug-workaround.js"></script>
</body>

</html>
